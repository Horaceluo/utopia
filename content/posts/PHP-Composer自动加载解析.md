---
title: "PHP Composer自动加载解析"
date: 2022-01-20T09:42:00+08:00
draft: false
isCJKLanguage: true
categories:
- 源码阅读
tags:
- 源码
- PHP
---

# 前言

composer在各个项目中已经有了广泛的使用。有了composer的加持，PHP项目的包管理变得非常简单。
通过composer，可以很便捷的安装、卸载第三方库，并且可以区分生产和开发使用的第三方包，例如：只在开发环境中使用的phpunit，可以作为开发依赖，只在开发环境中安装，在生产环境中就不需要安装了。

composer除了提供自动加载、管理包之外，还提供项目模板、包分发等功能。本文只对composer的加载原理进行分析。

# 原理分析

对于php来说，要引用其他文件的php，可以通过几个方法来实现：

- include
- include_onces
- require
- require_once

include 和 require的区别是对于错误的处理不同，include过程中如果发生错误，只会产生警告级别的提醒。而require过程中发生错误会是ERROR级别的错误。
onces的方法只会引入一次。如果require的是一个函数，那么多次使用require_once来进行引入，函数也会只执行一次。

## 注册自动加载

PHP的spl_autoload_register函数可以注册类的自动加载器，当使用未定义的类的时候，PHP会尝试使用spl_autoload_register注册的加载器进行加载类。
使用了composer之后，可以直接使用composer的加载器进行加载。

```php
require_once vendor/autoload.php
```

在vendor目录下(composer代码及第三方包所在的目录)，有个autoload.php文件。这个是composer自动生成的文件，内容通常如下

```php
<?php

// autoload.php @generated by Composer

require_once __DIR__ . '/composer/autoload_real.php';

return ComposerAutoloaderInitf73eef359dfdc5abf6a5c8d13adf36d8::getLoader();
```

从代码里可以看到，autoload.php实际上是执行composer目录下autoload_real.php的getLoader方法。在getLoader里面，就会使用spl_autoload_register进行注册加载器。

在composer目录下，有以下几个文件

- autoload_static.php
- autoload_classmap.php
- autoload_files.php
- autoload_namespace.php
- autoload_psr4.php

这个几个文件存储的是文件、类型的路径关系。当第三方依赖包有更新的时候，就会更新这个几个文件。

## composer.json 中的autoload配置

autoload配置项可以指定的目录与命名空间绑定在一起。这样composer的加载器就可以通过分析命名空间来确定需要加载哪份文件。
autoload支持不同的代码规范的加载包括：PSR-4、PSR-0、Classmap、Files。

### PSR-4

PSR-4是自动加载器规范，它规定了如何根据将文件路径来实现自动加载。例如ThinkPHP项目中模板中的composer.json上的PSR-4规范

```json
{
    "autoload": {
        "psr-4": {
            "app\\": "app"
        }
    }
}
```

app目录下的文件都是顶级命名空间app。假设app目录下有目录结构
```
app
  --controller
    --User.php
```
对于User.php，那么里面应该有名为User的类，命名为`app\controller`

```php
namespace app\controller;

class User
{
    
}
```