<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PHP Composer自动加载解析 | Horace</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu></ul><hr></nav><div class=article-meta><h1><span class=title>PHP Composer自动加载解析</span></h1><h2 class=date>2022/01/20</h2></div><main><h1 id=前言>前言</h1><p>composer在各个项目中已经有了广泛的使用。有了composer的加持，PHP项目的包管理变得非常简单。
通过composer，可以很便捷的安装、卸载第三方库，并且可以区分生产和开发使用的第三方包，例如：只在开发环境中使用的phpunit，可以作为开发依赖，只在开发环境中安装，在生产环境中就不需要安装了。</p><p>composer除了提供自动加载、管理包之外，还提供项目模板、包分发等功能。本文只对composer的加载原理进行分析。</p><h1 id=原理分析>原理分析</h1><p>对于php来说，要引用其他文件的php，可以通过几个方法来实现：</p><ul><li>include</li><li>include_onces</li><li>require</li><li>require_once</li></ul><p>include 和 require的区别是对于错误的处理不同，include过程中如果发生错误，只会产生警告级别的提醒。而require过程中发生错误会是ERROR级别的错误。
onces的方法只会引入一次。如果require的是一个函数，那么多次使用require_once来进行引入，函数也会只执行一次。</p><h2 id=注册自动加载>注册自动加载</h2><p>PHP的spl_autoload_register函数可以注册类的自动加载器，当使用未定义的类的时候，PHP会尝试使用spl_autoload_register注册的加载器进行加载类。
使用了composer之后，可以直接使用composer的加载器进行加载。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#000;font-weight:700>require_once</span> vendor<span style=color:#000;font-weight:700>/</span>autoload<span style=color:#000;font-weight:700>.</span>php
</span></span></code></pre></div><p>在vendor目录下(composer代码及第三方包所在的目录)，有个autoload.php文件。这个是composer自动生成的文件，内容通常如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;?</span>php
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// autoload.php @generated by Composer
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>require_once</span> <span style=color:teal>__DIR__</span> <span style=color:#000;font-weight:700>.</span> <span style=color:#d14>&#39;/composer/autoload_real.php&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>return</span> ComposerAutoloaderInitf73eef359dfdc5abf6a5c8d13adf36d8<span style=color:#000;font-weight:700>::</span><span style=color:teal>getLoader</span>();
</span></span></code></pre></div><p>从代码里可以看到，autoload.php实际上是执行composer目录下autoload_real.php的getLoader方法。在getLoader里面，就会使用spl_autoload_register进行注册加载器。</p><p>在composer目录下，有以下几个文件</p><ul><li>autoload_static.php</li><li>autoload_classmap.php</li><li>autoload_files.php</li><li>autoload_namespace.php</li><li>autoload_psr4.php</li></ul><p>这个几个文件存储的是文件、类型的路径关系。当第三方依赖包有更新的时候，就会更新这个几个文件。</p><h2 id=composerjson-中的autoload配置>composer.json 中的autoload配置</h2><p>autoload配置项可以指定的目录与命名空间绑定在一起。这样composer的加载器就可以通过分析命名空间来确定需要加载哪份文件。
autoload支持不同的代码规范的加载包括：PSR-4、PSR-0、Classmap、Files。</p><h3 id=psr-4>PSR-4</h3><p>PSR-4是自动加载器规范，它规定了如何根据将文件路径来实现自动加载。例如ThinkPHP项目中模板中的composer.json上的PSR-4规范</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:navy>&#34;autoload&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:navy>&#34;psr-4&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:navy>&#34;app\\&#34;</span>: <span style=color:#d14>&#34;app&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>app目录下的文件都是顶级命名空间app。假设app目录下有目录结构</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>app
</span></span><span style=display:flex><span>  --controller
</span></span><span style=display:flex><span>    --User.php
</span></span></code></pre></div><p>对于User.php，那么里面应该有名为User的类，命名为<code>app\controller</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#000;font-weight:700>namespace</span> app\controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>User</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></main><footer></footer></body></html>